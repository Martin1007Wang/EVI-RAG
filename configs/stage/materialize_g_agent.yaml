# @package _global_
#
# Stage: Materialize g_agent cache from a trained retriever checkpoint.
# One run produces exactly one split file (train/validation/test). Use Hydra multirun for all splits.

defaults:
  - override /data: retriever
  - override /model: retriever_module
  - override /callbacks: g_agent_generation
  - override /logger: none
  - override /trainer: predict

stage:
  name: materialize_g_agent
  task_name: "materialize/g_agent"
  tags: ["materialize", "g_agent"]
  split: test
  anchor_top_k: ${window.anchor_top_k}
  force_include_gt: false
  run:
    loop: predict
    return_predictions: false

data:
  splits:
    test: ${stage.split}

ckpt_path: ${ckpt.retriever}

callbacks:
  g_agent_generation:
    settings:
      output_path: ${dataset.materialized_dir}/g_agent/${stage.split}_g_agent.pt
    lmdb_path: ${dataset.materialized_dir}/embeddings/${stage.split}.lmdb
