# @package _global_
#
# Experiment: retriever artifact generation (g_agent + eval_retriever cache).

defaults:
  - override /data: retriever
  - override /model: retriever_module
  - override /callbacks: retriever_eval
  - override /logger: none
  - override /trainer: predict

run:
  name: eval_retriever
  task_name: "eval/retriever"
  tags: ["eval", "retriever"]
  run_all_splits: true
  edge_top_k: 400
  max_hops: 3
  ckpt_path: ${ckpt.retriever}
  dataset_variants:
    - ${dataset.dataset_family}
    - ${dataset.dataset_family}-sub
  require_dual_datasets: true

selector_eval:
  enabled: true
  selector: retriever_topk
  k_values: ${window.k_values}
  allow_empty_dag: true
  drop_unreachable: true
  output_dir: ${paths.output_dir}
  g_agent_path: ${dataset.artifact_dir}/g_agent/${run.split}_g_agent.pt
  num_workers: 0

bfs_chain_eval:
  enabled: false
  output_dir: ${dataset.artifact_dir}/eval_bfs
  g_agent_path: ${dataset.artifact_dir}/g_agent/${run.split}_g_agent.pt
  artifact_name: eval_bfs
  schema_version: 1
  max_chain_length: ${run.max_hops}
  min_chain_length: 1
  max_chains_per_sample: 100
  max_total_chains: 5000
  allow_backward: true
  max_branch_per_node: null
  forbid_edge_revisit: true
  forbid_node_revisit: false
  drop_unreachable: false
  overwrite: true

ckpt:
  retriever: ${oc.env:RETRIEVER_CKPT,null}

data:
  splits:
    test: ${run.split}

model:
  evaluation_cfg:
    split: ${run.split}
    emit_predict_outputs: true

callbacks:
  retriever_prediction_writer:
    output_dir: ${dataset.artifact_dir}/eval_retriever
    artifact_name: eval_retriever
    schema_version: 1
    textualize: true
    entity_vocab_path: ${dataset.out_dir}/entity_vocab.parquet
    relation_vocab_path: ${dataset.out_dir}/relation_vocab.parquet
