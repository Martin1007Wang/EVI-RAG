# @package _global_
#
# Experiment: retriever evaluation (mask-off checkpoint).

defaults:
  - override /data: retriever
  - override /model: retriever_module
  - override /callbacks: retriever_eval
  - override /logger: none
  - override /trainer: predict

model:
  compile_model: false
  retriever:
    hide_seek_cfg:
      enabled: false
  evaluation_cfg:
    split: ${run.split}
    emit_predict_outputs: false
    edge_recall_k: ${window.k_values}
    connectivity_k: ${window.k_values}
    ablate_topic: false

run:
  name: eval_retriever
  task_name: "eval/retriever"
  tags: ["eval", "retriever", "maskoff"]
  run_all_splits: true
  edge_top_k: 500
  max_hops: 3
  build_g_agent: false
  eval_mode: test
  ckpt_path: ${ckpt.retriever}
  dataset_variants:
    - ${dataset.dataset_family}
    - ${dataset.dataset_family}-sub
  require_dual_datasets: true

bfs_chain_eval:
  enabled: false
  output_dir: ${dataset.artifact_dir}/eval_bfs
  g_agent_path: ${dataset.artifact_dir}/g_agent/${run.split}_g_agent.pt
  artifact_name: eval_bfs
  schema_version: 1
  max_chain_length: ${run.max_hops}
  min_chain_length: 1
  max_chains_per_sample: 100
  max_total_chains: 5000
  allow_backward: true
  max_branch_per_node: null
  forbid_edge_revisit: true
  forbid_node_revisit: false
  drop_unreachable: false
  overwrite: true

ckpt:
  retriever: ${oc.env:RETRIEVER_CKPT,null}

data:
  splits:
    test: ${run.split}

callbacks:
  retriever_topk_edge_writer:
    output_dir: ${dataset.artifact_dir}/eval_retriever
    artifact_name: eval_retriever
    schema_version: 1
    textualize: true
    entity_vocab_path: ${dataset.out_dir}/entity_vocab.parquet
    relation_vocab_path: ${dataset.out_dir}/relation_vocab.parquet
