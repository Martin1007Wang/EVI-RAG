# @package _global_

# 共用的 GFlowNet 训练模板；数据集由具体 experiment 覆盖。
defaults:
  - override /data: gflownet
  - override /model: gflownet_local_gat
  - override /callbacks: default
  - override /logger: wandb
  - override /trainer: gpu

task_name: "gflownet_train"
tags: ["gflownet"]
train: true
test: true
ckpt_path: null
seed: 42
optimized_metric: "val/answer_hit"
ckpt:
  retriever: ${oc.env:RETRIEVER_CKPT,null}

# 打开 GFlowNet 专用 debug 日志（独立文件 logs/gflownet_debug.log）。
# 统一 debug 开关：控制 gflownet.debug 和 env.debug。
debug: true

# Ensure validation runs every epoch for early stopping/monitoring.
trainer:
  check_val_every_n_epoch: 1

# Strong + reproducible default: optimize SubTB on-policy, and keep a GT-trajectory SubTB anchor.
# This avoids hand-tuned BC schedules while preventing collapse when rewards are sparse.
model:
  training_cfg:
    num_train_rollouts: 2
    # Disable behavior cloning (pure flow objective; no cross-entropy).
    bc_coef: 0.0
    bc_include_stop: false
    bc_schedule:
      type: none
    # Fixed GT-SubTB anchor (teacher-forcing) to ensure stable learning signal.
    gt_flow_coef: 1.0
    gt_flow_schedule:
      type: none

# Override callback monitors for GFlowNet (no ranking/mrr available)
callbacks:
  model_checkpoint:
    monitor: val/answer_hit
    mode: max
    filename: "epoch_{epoch:03d}"
    auto_insert_metric_name: False
    save_weights_only: True
  early_stopping:
    monitor: val/answer_hit
    mode: max
    patience: 50
