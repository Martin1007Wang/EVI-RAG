# @package _global_
#
# Experiment: GFlowNet evaluation (predict + metrics + rollouts).

defaults:
  - override /data: g_retrieval
  - override /model: gflownet_module
  - override /callbacks: gflownet_eval
  - override /logger: none
  - override /trainer: predict

run:
  name: eval_gflownet
  task_name: "eval/gflownet"
  tags: ["eval", "gflownet"]
  split: test
  eval_mode: predict
  ckpt_path: ${ckpt.gflownet}
  filter_missing_start: true
  dataset_variants:
    - ${dataset.dataset_family}
    - ${dataset.dataset_family}-sub
  require_dual_datasets: true

ckpt:
  gflownet: ${oc.env:GFLOWNET_CKPT,null}

callbacks:
  gflownet_rollout_artifact_writer:
    textualize: true

data:
  splits:
    test: ${run.split}
  precompute_edge_batch: false
  expand_multi_start: false
  expand_multi_answer: false

model:
  env:
    max_steps: ${dataset.max_steps}

  selector_cfg:
    enabled: true
    epsilon: 0.1

  backward_cfg:
    share_state_encoder: false
    share_edge_scorer: false

  training_cfg:
    num_train_rollouts: 3
    rollout_chunk_size: 3
    manual_gradient_clip_val: 1.0
    manual_gradient_clip_algorithm: norm
    manual_gradient_clip_norm_type: 2.0
    adaptive_gradient_clip: false
    grad_clip_ema_beta: null
    grad_clip_tail_prob: null
    grad_clip_log_eps: 1.0e-8
    grad_clip_tail_prob_eps: 1.0e-6
    grad_non_finite_max_params: 20
    subtb:
      enabled: true
      num_subtrajectories: 1
    dual_stream:
      enabled: true
      stream_forward_weight: 1.0
      stream_forward_max_steps: null
      stream_forward_weight_start: 0.0
      stream_forward_weight_schedule: none
      stream_forward_weight_anneal_epochs: null
    z_align:
      enabled: false
      weight: 1.0
    h_guidance:
      enabled: true
      beta_start: 0.0
      beta_end: 1.0
      warmup_progress: 0.1
      apply_eval: true
      stop_gradient: true
      scale: 1.0
    target_sampling:
      mode: random_one
